name: encryptJSON file
on: workflow_dispatch
jobs:
  download_json:
    runs-on: self-hosted
    environment:
      dev
    steps:
      - name: Download JSON file
        run: |
          Invoke-WebRequest -Uri "https://raw.githubusercontent.com/DivyaPrabhavathi/Maven/main/NSI.json" -OutFile "NSI.json"
        shell: powershell
      - name: Assign values to JSON file
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          ENV_NAME: ${{ secrets.ENV_NAME }}
        run: |
          # Read JSON file
          $json = Get-Content NSI.json -Raw | ConvertFrom-Json
          $json.Sphere.USERNAME = "$env:DOCKER_USERNAME"
          $json.Sphere.PASSWORD = "$env:DOCKER_PASSWORD"
          $json.Sphere.NAME = "$env:ENV_NAME"
          $json | ConvertTo-Json | Set-Content -Path NSI.json
        shell: powershell
      - name: Encrypt JSON file and generate key
        run: |
          # Generate a new AES key
          $bytes = New-Object byte[](32)
          (New-Object System.Security.Cryptography.RNGCryptoServiceProvider).GetBytes($bytes)
          $key = [System.Convert]::ToBase64String($bytes)
          # Encrypt the JSON file
          $secureJson = ConvertTo-SecureString -String (Get-Content NSI.json -Raw) -Key $bytes
          $encryptedJson = ConvertFrom-SecureString -SecureString $secureJson -Key $bytes
          # Save the encrypted JSON to a new file
          $encryptedJson | Set-Content -Path "NSI.encrypted.json"
          # Save the key to a file
          $key | Set-Content -Path "key.txt"
        shell: powershell
